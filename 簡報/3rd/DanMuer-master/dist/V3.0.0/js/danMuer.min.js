(function(f,g){const l=Symbol("loop"),m=Symbol("init"),n=f.requestAnimationFrame||f.webkitRequestAnimationFrame;class o{constructor(u,z={}){this.save=[],this.canvas=u,this.cxt=u.getContext("2d"),this.width=0,this.height=0,this.rows={slide:[],top:[],bottom:[]},this.filters={},this.leftTime=z.leftTime||2e3,this.space=z.space||10,this.unitHeight=0,this.rowNum=0,this.baseSpeed=z.baseSpeed||2,this.baseWidth=z.baseWidth||800,this.startIndex=0,this.looped=!1,this.changeStyle(z)}add(u){u&&(this.looped&&this.countWidth([u]),this.filter(u),this.save.push(u))}clear(){this.save=[],this.startIndex=0}pause(){this.paused=!0}run(){this.paused=!1}addFilter(u,z){if(!u||!z)return!1;let[A]=[this.filters];A[u]||(A[u]=[]),A[u].find(B=>z===B)||A[u].push(z),this.doFilter()}filter(u){let z=this.filters;for(let A of Object.keys(z)){let B=z[A],[C,D]=[0,B.length];for(;C<D;C++){if(!u[A].includes(B[C])){u.hide=!1;continue}return u.hide=!0,!1}}}doFilter(){for(let[u,z,A]=[0,this.save];A=z[u++];)this.filter(A)}removeFilter(u,z){if(!u)return!1;let[A,B]=[this.filters];if(B=A[u],!B)return!1;if(!z)delete A[u];else for(let[C,D,E]=[0,B];E=D[C++];)if(E===z){A[u].splice(C-1,1);break}this.doFilter()}clearRect(){this.cxt.clearRect(0,0,this.width,this.height)}font(){this.globalFont=this.globalStyle+" "+this.globalWeight+" "+this.globalSize+" "+this.globalFamily}addGradient(u,z={}){if(!u||"string"!=typeof u)return!1;let A=null;if("radial"==u)A=this.addRadialGradient(z);else if("linear"==u)A=this.addLinearGradient(z);else return!1;this.changeStyle({fontColor:A})}addLinearGradient(u){let[z,A,B,C,D]=[u.startX||0,u.startY||0,u.endX||this.width,u.endY||this.height,u.colorStops||[{point:0,color:this.globalColor},{point:1,color:this.globalColor}]],E=this.cxt.createLinearGradient(z,A,B,C);for(let F of D)E.addColorStop(F.point,F.color);return E}addRadialGradient(u){let[z,A,B,C,D,E,F]=[u.startX||this.width/2,u.startY||this.height/2,u.startR||0,u.endX||this.width/2,u.endY||this.height/2,u.endR||this.width,u.colorStops||[{point:0,color:this.globalColor},{point:1,color:this.globalColor}]],G=this.cxt.createRadialGradient(z,A,B,C,D,E);for(let H of F)G.addColorStop(H.point,H.color);return G}changeStyle(u={}){this.globalSize=u.fontSize||this.globalSize||"24px",this.globalFamily=u.fontFamily||this.globalFamily||"\u5FAE\u8F6F\u96C5\u9ED1",this.globalStyle=u.fontStyle||this.globalStyle||"normal",this.globalWeight=u.fontWeight||this.globalWeight||"normal",this.globalColor=u.fontColor||this.globalColor||"#ffffff",this.opacity=u.opacity||this.opacity||1,this.globalChanged=!0}initStyle(u){this.globalChanged=!1,this.font(),u.font=this.globalFont,u.textBaseline="middle",u.fillStyle=this.globalColor,u.globalAlpha=this.opacity}update(u,z,A){let[B,C]=[this.save,this.cxt];if(this.globalChanged&&this.initStyle(C),this.looped||this.countWidth(B),this.paused)return!1;this.refresh(B);let[D,E]=[this.startIndex];for(C.clearRect(0,0,u,z);E=B[D++];)this.step(E,A),this.draw(E,C),this.recovery(E,u)}reset(u=0){for(let[z,A,B,C,D]=[this.save,this.width,this.leftTime,u];D=z[C++];)"slide"==D.type?(D.x=A,D.rowRid=!1):D.leftTime=B,D.recovery=!1;this.startIndex=u}getSize(){this.width=this.canvas.width,this.height=this.canvas.height,this.speedScale=g.max(this.width/this.baseWidth,0.7),this.deleteRow(),this.countRows(),this.globalChanged=!0}deleteRow(){for(let[u,z,A]=[this.save,0];A=u[z++];)A.row=null}countRows(){let u=parseInt(this.globalSize)+this.space,[z,A]=[(this.height-20)/u>>0,this.rows];for(let B of Object.keys(A))A[B]=[];for(let C,B=0;B<z;B++)C={idx:B,y:u*B+20},A.slide.push(C),B>=z/2?A.bottom.push(C):A.top.push(C);this.unitHeight=u,this.rowNum=z}getRow(u){if(u.row)return u.row;const[z,A]=[this.rows,u.type],B="bottom"==A?z[A].pop():z[A].shift(),C=this["getRow_"+A]();return B&&"slide"==u.type&&(u.x+=8*B.idx,u.speed+=B.idx/3),B||C}getRow_bottom(){return{y:20+this.unitHeight*(g.random()*this.rowNum/2+this.rowNum/2<<0),speedChange:!1,tempItem:!0}}getRow_slide(){return{y:20+this.unitHeight*(g.random()*this.rowNum<<0),speedChange:!0,tempItem:!0}}getRow_top(){return{y:20+this.unitHeight*(g.random()*this.rowNum/2<<0),speedChange:!1,tempItem:!0}}countWidth(u,z=this.cxt){this.looped=!0;for(let D,[A,B,C]=[this.width,0];C=u[B++];)D=z.measureText(C.text).width>>0,C.width=D,C.height=parseInt(this.globalSize),C.x=A,C.speed=this.baseSpeed,"slide"!=C.type&&(C.x=(A-D)/2,C.leftTime=this.leftTime,C.speed=0)}updateStyle(u,z){z.font=this.globalStyle+" "+this.globalWeight+" "+u.fontSize+" "+this.globalFamily,z.fillStyle=u.color||this.globalColor}step(u,z){let A=this.getRow(u);A.speedChange&&(A.speedChange=!1,u.speed+=2*g.random()+1>>0);let B=u.speed*this.speedScale*z/16>>0;u.leftTime?u.leftTime-=z:"",u.x-=B,u.y=u.y||A.y,u.row=A}draw(u,z){return u.recovery||u.hide?!1:void(z.save(),u.change&&this.updateStyle(u,z),z.fillText(u.text,u.x,u.y),z.restore())}recovery(u,z){return"slide"==u.type?(u.recovery=this.recoverySlide(u,z),!1):void(u.recovery=this.recoveryStatic(u))}recoverySlide(u,z){let[A,B]=[u.x,u.width];return u.rowRid||!(A+B<z)||u.row.tempItem||(this.rows[u.type].unshift(u.row),u.rowRid=!0),!(A>-B)}recoveryStatic(u){if(0<u.leftTime)return!1;let z=u.type;return u.row.tempItem||(this.rows[z].unshift(u.row),u.row=null),!0}refresh(u){let[z,A,B]=[this.startIndex,,this.rows];for(let C of Object.keys(B))B[C].sort(function(D,E){return D.y-E.y});for(;A=u[z++];){if(!A.recovery)return!1;this.startIndex=z,A.row=null}}}class p{constructor(u,z={}){this.canvas=u,this.cxt=u.getContext("2d"),this.enable=!1!==z.enable,this.startIndex=0,this.save=[]}add(u){if(!u||"object"!=typeof u)return!1;for(let[z,A,B]=[u.steps,0];B=z[A++];)this.initStep(B);this.save.push(u)}clear(){this.save=[],this.startIndex=0}reset(u){for(let[z,A]=[this.save];A=z[u++];)A.hide=!1}pause(){this.paused=!0}run(){this.paused=!1}enableEffect(){this.enable=!0}disableEffect(){this.enable=!1}initStep(u){u.type=u.type||"linear",u.scaleStartX=u.scaleStartX||1,u.scaleStartY=u.scaleStartY||1,u.scaleEndX=u.scaleEndX||1,u.scaleEndY=u.scaleEndY||1,u.rotateEnd=u.rotateEnd||0,u.rotateStart=u.rotateStart||0,u.endX=u.endX||0,u.startX=u.startX||0,u.endY=u.endY||0,u.startY=u.startY||0,u.skewStartX=u.skewStartX||0,u.skewStartY=u.skewStartY||0,u.skewEndX=u.skewEndX||0,u.skewEndY=u.skewEndY||0,u.pastTime=u.pastTime||0,u.duration=u.duration||3e3,u.scaleDistX=u.scaleEndX-u.scaleStartX,u.scaleDistY=u.scaleEndY-u.scaleStartY,u.rotateDist=u.rotateEnd-u.rotateStart,u.opacity=u.opacity||1,u.fillStyle=u.fillStyle||"#ffffff",u.strokeStyle=u.strokeStyle||"#ffffff",u.radius=u.radius||10,u.distX=u.points?u.distX||0:u.endX-u.startX,u.distY=u.points?u.distY||0:u.endY-u.startY,u.skewDistX=u.skewEndX-u.skewStartX,u.skewDistY=u.skewEndY-u.skewStartY}getSize(){this.width=this.canvas.width,this.height=this.canvas.height}clearRect(){this.cxt.clearRect(0,0,this.width,this.height)}update(u,z,A){if(this.paused)return!1;let[B,C]=[this.canvas,this.cxt];if(C.clearRect(0,0,u,z),!this.enable)return!1;for(let[D,E,F]=[this.startIndex,this.save];F=E[D++];)if(!F.hide){let I=F.steps,J=I[F.currentIndex];this.step(F,J,A),this.draw(F,J,C),this.recovery(F,J)}}step(u,z,A){z.pastTime+=A;let[B,C,D]=[z.type||"linear",z.pastTime,z.duration];"polygon"==u.type&&this.stepCheckPolygon(z,u),z.x=this.Tween(B,C,z.startX,z.distX,D),z.y=this.Tween(B,C,z.startY,z.distY,D),z.scaleX=this.Tween(B,C,z.scaleStartX,z.scaleDistX,D),z.scaleY=this.Tween(B,C,z.scaleStartY,z.scaleDistY,D),z.rotate=this.Tween(B,C,z.rotateStart,z.rotateDist,D),z.skewX=this.Tween(B,C,z.skewStartX,z.skewDistX,D),z.skewY=this.Tween(B,C,z.skewStartY,z.skewDistY,D)}stepCheckPolygon(u,z){let A=z.currentIndex;if(0==A){let[B,C,D,E]=[0,0,u.points.concat([])||[],0],[F,G]=[0];for(;G=D[F++];)B+=G.x,C+=G.y,E++;if(0>=E)return!1;u.startX=B/E,u.startY=C/E,u.firstPoint=u.points.concat([]).shift()}else if(!u.points){let B=z.steps[A-1];u.startX=B.x,u.startY=B.y,u.points=B.points,u.firstPoint=B.firstPoint}}draw(u,z,A){A.save(),!this[u.type]||this[u.type](z,A,g,g.PI/180),A.restore()}rect(u,z,A,B){let[C,D,E,F]=[u.x,u.y,u.width,u.height],[G,H]=[A.tan(u.skewX*B),A.tan(u.skewY*B)];z.beginPath(),z.transform(u.scaleX,G,H,u.scaleY,C+E/2,D+F/2),z.rotate(u.rotate*A.PI/180),z.globalAlpha=u.opacity,z.rect(-E/2,-F/2,E,F),z.closePath(),z.fillStyle=u.fillStyle,z.strokeStyle=u.strokeStyle,z.fill(),z.stroke()}text(u,z,A,B){let[C,D,E,F,G]=[u.fontStyle||"normal",u.fontWeight||"normal",u.fontSize||"24px",u.fontFamily||"\u5FAE\u8F6F\u96C5\u9ED1",u.text||""];z.font=C+" "+D+" "+E+" "+F;let[H,I,J,K]=[u.x,u.y,z.measureText(G).width,parseInt(E)],[L,M]=[A.tan(u.skewX*B),A.tan(u.skewY*B)];z.transform(u.scaleX,L,M,u.scaleY,H+J/2,I+K/2),z.rotate(u.rotate*A.PI/180),z.globalAlpha=u.opacity,z.fillStyle=u.fillStyle,z.strokeStyle=u.strokeStyle,z.fillText(G,-J/2,-K/2),z.strokeText(G,-J/2,-K/2)}polygon(u,z,A,B){let C=u.points,[D,E,F]=[u.x,u.y,u.firstPoint],[G,H]=[A.tan(u.skewX*B),A.tan(u.skewY*B)];z.beginPath(),z.transform(u.scaleX,G,H,u.scaleY,D,E),z.rotate(u.rotate*A.PI/180),z.globalAlpha=u.opacity,z.fillStyle=u.fillStyle,z.strokeStyle=u.strokeStyle,z.moveTo(F.x-D,F.y-E);for(let[I,J]=[0];J=C[I++];)z.lineTo(J.x-D,J.y-E);z.closePath(),z.fill(),z.stroke()}circle(u,z,A,B){let[C,D,E]=[u.x,u.y,u.radius],[F,G]=[A.tan(u.skewX*B),A.tan(u.skewY*B)];z.beginPath(),z.transform(u.scaleX,F,G,u.scaleY,C+E,D+E),z.rotate(u.rotate*A.PI/180),z.globalAlpha=u.opacity,z.fillStyle=u.fillStyle,z.strokeStyle=u.strokeStyle,z.arc(0,0,E,0,2*A.PI,!1),z.closePath(),z.fill(),z.stroke()}recovery(u,z){z.pastTime>=z.duration&&(u.currentIndex++,z.pastTime=0),u.steps[u.currentIndex]||(u.hide=!0,u.currentIndex=0)}Tween(u,...z){const A={linear:(B,C,D,E)=>D*B/E+C,easeIn:(B,C,D,E)=>D*(B/=E)*B+C,easeOut:(B,C,D,E)=>-D*(B/=E)*(B-2)+C,easeInOut:(B,C,D,E)=>{return 1>(B/=E/2)?D/2*B*B+C:-D/2*(--B*(B-2)-1)+C}};return!!A[u]&&A[u](...z)}}class q{constructor(u,z={}){if(!u)throw new Error("\u6CA1\u6709\u8BBE\u7F6E\u6B63\u786E\u7684wrapper");this.wrapper=u,this.width=u.clientWidth,this.height=u.clientHeight,this.canvas=document.createElement("canvas"),this.canvas2=document.createElement("canvas"),this.normal=new o(this.canvas,z),this.effect=new p(this.canvas2,z),this.name=z.name||"",this.fps=0,this.drawing=z.auto||!1,this.startTime=new Date().getTime(),this[m](),this[l](),z.enableEvent&&this.initEvent(z)}[m](){this.canvas.style.cssText="position:absolute;z-index:100;top:0px;left:0px;",this.canvas2.style.cssText="position:absolute;z-index:101;top:0px;left:0px;",this.setSize(),this.wrapper.appendChild(this.canvas),this.wrapper.appendChild(this.canvas2)}[l](u=this.normal,z=this.effect,A=this.startTime){let B=new Date().getTime();if(!this.drawing)return u.clearRect(),z.clearRect(),!1;let[C,D,E]=[this.width,this.height,B-A];this.fps=1e3/E>>0,u.update(C,D,E),z.update(C,D,E);n(()=>{this[l](u,z,B)})}initEvent(u){let[z,A,B]=[this.canvas2,this.normal,!1];z.onmouseup=function(C){if(C=C||event,B)return!1;if(B=!0,2==C.button){let[D,E]=[C.target.getBoundingClientRect(),""],[F,G,H,I,J]=[C.clientX-D.left,C.clientY-D.top,0,A.save];for(;J=I[H++];){let[L,M,N,O]=[J.x,J.y,J.width+10,J.height];if(!(F<L||F>L+N||G<M-O/2||G>M+O/2||J.hide||J.recovery)){E=J;break}}let K=u.callback||function(){};K(E),B=!1}},z.oncontextmenu=function(C){C=C||event,C.preventDefault()}}inputData(u={}){return"object"==typeof u&&u.type&&void this.normal.add(u)}inputEffect(u={}){return"object"==typeof u&&u.type&&u.steps&&void this.effect.add(u)}clear(){this.normal.clear(),this.effect.clear()}reset(u,z){this.normal.reset(u),this.effect.reset(z)}pause(){this.normal.pause(),this.effect.pause()}run(){this.normal.run(),this.effect.run()}addFilter(u,z){this.normal.addFilter(u,z)}removeFilter(u,z){this.normal.removeFilter(u,z)}disableEffect(){this.effect.disableEffect()}enableEffect(){this.effect.enableEffect()}setSize(u=this.width,z=this.height){return!Number.isInteger(u)||0>u||!Number.isInteger(z)||0>z?!1:void(this.width=u,this.height=z,this.canvas.width=u,this.canvas.height=z,this.canvas2.width=u,this.canvas2.height=z,this.normal.getSize(),this.effect.getSize())}getSize(){return{width:this.width,height:this.height}}changeStyle(u={}){this.normal.changeStyle(u)}addGradient(u,z){this.normal.addGradient(u,z)}start(){return!this.drawing&&void(this.drawing=!0,this[l]())}stop(){this.drawing=!1}getFPS(){return this.fps}}let s=function(u,z){let A=new Proxy(new q(u,z),{get:function(C,D){return"function"==typeof C[D]?C[D].bind(C):C[D]}}),B=A;return{pause:B.pause,run:B.run,start:B.start,stop:B.stop,changeStyle:B.changeStyle,addGradient:B.addGradient,setSize:B.setSize,inputData:B.inputData,inputEffect:B.inputEffect,clear:B.clear,reset:B.reset,addFilter:B.addFilter,removeFilter:B.removeFilter,disableEffect:B.disableEffect,enableEffect:B.enableEffect,getSize:B.getSize,getFPS:B.getFPS}};"undefined"!=typeof module&&module.exports?module.exports=s:"function"==typeof define&&define.amd?define(function(){return s}):f.DanMuer=s})(window,Math);